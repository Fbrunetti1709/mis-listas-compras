<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Mis Listas Pro - Completa</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #667eea;
            --primary-dark: #5568d3;
            --secondary: #764ba2;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --info: #17a2b8;
            --light: #f8f9fa;
            --dark: #333;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            min-height: 100vh;
            padding: 10px;
            -webkit-tap-highlight-color: transparent;
            transition: background 0.3s;
        }

        body.dark-mode {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        }

        body.dark-mode .main-content {
            background: #2d3748;
            color: #e2e8f0;
        }

        body.dark-mode .item,
        body.dark-mode .add-item-section,
        body.dark-mode .stats,
        body.dark-mode .stat,
        body.dark-mode .category-manager,
        body.dark-mode .search-box input,
        body.dark-mode .filter-buttons button,
        body.dark-mode input,
        body.dark-mode textarea,
        body.dark-mode select {
            background: #4a5568;
            color: #e2e8f0;
            border-color: #718096;
        }

        body.dark-mode .item-text,
        body.dark-mode .stat-label,
        body.dark-mode h2, body.dark-mode h3 {
            color: #e2e8f0;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            color: white;
            margin-bottom: 15px;
        }

        header h1 {
            font-size: 1.8em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header-controls {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .user-selector, .sync-status, .theme-toggle {
            background: rgba(255, 255, 255, 0.2);
            padding: 6px 10px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85em;
        }

        .user-selector select {
            background: white;
            border: none;
            padding: 4px 8px;
            border-radius: 15px;
            font-size: 0.9em;
            cursor: pointer;
        }

        .theme-toggle {
            cursor: pointer;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #28a745;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .main-content {
            background: white;
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .search-box {
            margin-bottom: 15px;
        }

        .search-box input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
        }

        .filter-buttons {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            overflow-x: auto;
        }

        .filter-buttons button {
            padding: 8px 15px;
            border: 2px solid var(--primary);
            background: white;
            color: var(--primary);
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.85em;
            white-space: nowrap;
            font-weight: 600;
        }

        .filter-buttons button.active {
            background: var(--primary);
            color: white;
        }

        .sort-controls {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
        }

        .sort-controls select {
            flex: 1;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 0.9em;
        }

        .section-selector h2 {
            font-size: 1.2em;
            color: var(--dark);
            margin-bottom: 12px;
            text-align: center;
        }

        .section-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .section-btn {
            padding: 15px 10px;
            font-size: 0.95em;
            border: 2px solid var(--primary);
            background: white;
            color: var(--primary);
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
            touch-action: manipulation;
        }

        .section-btn:active {
            transform: scale(0.95);
        }

        .section-btn.active {
            background: var(--primary);
            color: white;
        }

        .category-manager {
            margin-top: 15px;
            padding: 12px;
            background: var(--light);
            border-radius: 10px;
        }

        .category-manager h3 {
            font-size: 1em;
            margin-bottom: 10px;
            color: var(--dark);
        }

        .add-category-form {
            display: flex;
            gap: 8px;
        }

        .add-category-form input {
            flex: 1;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 0.9em;
        }

        .btn-small {
            padding: 10px 12px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: bold;
        }

        .list-container {
            margin-top: 15px;
            display: none;
        }

        .list-header {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 12px;
        }

        .list-header h2 {
            color: var(--dark);
            font-size: 1.3em;
            text-align: center;
        }

        .list-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .back-btn, .clear-btn, .export-btn, .import-btn {
            padding: 10px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.85em;
            touch-action: manipulation;
        }

        .back-btn {
            background: #6c757d;
            color: white;
        }

        .clear-btn {
            background: var(--danger);
            color: white;
        }

        .export-btn {
            background: var(--success);
            color: white;
        }

        .import-btn {
            background: var(--info);
            color: white;
        }

        .add-item-section {
            background: var(--light);
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .add-item-section h3 {
            font-size: 1em;
            margin-bottom: 10px;
            color: var(--dark);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 8px;
        }

        .form-full {
            grid-column: 1 / -1;
        }

        .add-item-section input, 
        .add-item-section textarea,
        .add-item-section select {
            width: 100%;
            padding: 10px;
            font-size: 16px;
            border: 2px solid #ddd;
            border-radius: 8px;
        }

        .add-item-section textarea {
            resize: vertical;
            min-height: 50px;
            font-family: inherit;
        }

        .add-item-section input:focus, 
        .add-item-section textarea:focus,
        .add-item-section select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .priority-selector {
            display: flex;
            gap: 5px;
        }

        .priority-btn {
            flex: 1;
            padding: 8px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85em;
        }

        .priority-btn.active {
            border-color: var(--danger);
            background: var(--danger);
            color: white;
        }

        .priority-btn.medium.active {
            border-color: var(--warning);
            background: var(--warning);
            color: var(--dark);
        }

        .priority-btn.low.active {
            border-color: var(--success);
            background: var(--success);
            color: white;
        }

        .add-btn {
            width: 100%;
            padding: 12px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            touch-action: manipulation;
            margin-top: 8px;
        }

        .add-btn:active {
            transform: scale(0.98);
            background: var(--primary-dark);
        }

        .items-list {
            list-style: none;
            margin-bottom: 15px;
        }

        .item {
            background: var(--light);
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 10px;
            border-left: 4px solid var(--primary);
            transition: transform 0.2s;
        }

        .item:active {
            transform: scale(0.98);
        }

        .item.completed {
            opacity: 0.6;
            border-left-color: var(--success);
        }

        .item.priority-high {
            border-left-color: var(--danger);
            background: #fff5f5;
        }

        .item.priority-medium {
            border-left-color: var(--warning);
            background: #fffbf0;
        }

        .item.priority-low {
            border-left-color: var(--success);
        }

        .item-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
        }

        .item input[type="checkbox"] {
            width: 22px;
            height: 22px;
            cursor: pointer;
            flex-shrink: 0;
        }

        .item-text {
            flex: 1;
            font-size: 1em;
            color: var(--dark);
            font-weight: 600;
        }

        .item.completed .item-text {
            text-decoration: line-through;
        }

        .item-price {
            font-weight: bold;
            color: var(--success);
            font-size: 1em;
        }

        .priority-badge {
            font-size: 0.75em;
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: bold;
        }

        .priority-high-badge {
            background: var(--danger);
            color: white;
        }

        .priority-medium-badge {
            background: var(--warning);
            color: var(--dark);
        }

        .priority-low-badge {
            background: var(--success);
            color: white;
        }

        .item-image {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 8px;
            margin-top: 8px;
            cursor: pointer;
        }

        .item-details {
            padding-left: 30px;
            font-size: 0.85em;
            color: #666;
            margin-top: 6px;
        }

        .item-detail-row {
            margin: 3px 0;
        }

        .item-detail-label {
            font-weight: 600;
            color: var(--dark);
        }

        .item-actions {
            display: flex;
            gap: 6px;
            margin-top: 8px;
            padding-left: 30px;
        }

        .delete-btn, .edit-btn, .duplicate-btn {
            flex: 1;
            padding: 6px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8em;
            font-weight: bold;
        }

        .delete-btn {
            background: var(--danger);
            color: white;
        }

        .edit-btn {
            background: var(--warning);
            color: var(--dark);
        }

        .duplicate-btn {
            background: var(--info);
            color: white;
        }

        .empty-message {
            text-align: center;
            color: #999;
            font-size: 1em;
            padding: 30px 15px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            padding: 12px;
            background: var(--light);
            border-radius: 10px;
            margin-bottom: 12px;
        }

        .stat {
            text-align: center;
            padding: 8px;
            background: white;
            border-radius: 8px;
        }

        .stat-number {
            font-size: 1.4em;
            font-weight: bold;
            color: var(--primary);
        }

        .stat-label {
            color: #666;
            margin-top: 3px;
            font-size: 0.8em;
        }

        .chart-container {
            margin: 12px 0;
            padding: 15px;
            background: var(--light);
            border-radius: 10px;
        }

        .progress-bar {
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 8px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.8em;
            font-weight: bold;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 15px;
            max-width: 500px;
            width: 100%;
            max-height: 85vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .modal-header h3 {
            font-size: 1.2em;
            color: var(--dark);
        }

        .close-modal {
            background: var(--danger);
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2em;
        }

        .image-preview {
            width: 100%;
            max-height: 200px;
            object-fit: contain;
            border-radius: 10px;
            margin: 10px 0;
        }

        .offline-mode {
            background: #fff3cd;
            padding: 8px;
            border-radius: 8px;
            margin-bottom: 12px;
            text-align: center;
            color: #856404;
            font-size: 0.85em;
        }

        .quick-add {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }

        .quick-add-btn {
            padding: 6px 12px;
            background: #e9ecef;
            border: 1px solid #ddd;
            border-radius: 15px;
            font-size: 0.85em;
            cursor: pointer;
        }

        @media print {
            body {
                background: white;
            }
            .header-controls, .sync-status, .add-item-section, 
            .item-actions, .list-actions, .no-print, .search-box,
            .filter-buttons, .sort-controls {
                display: none !important;
            }
        }

        @media (max-width: 480px) {
            header h1 {
                font-size: 1.5em;
            }
            .stats {
                grid-template-columns: repeat(2, 1fr);
            }
            .list-actions {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üõí Mis Listas Pro</h1>
            <div class="header-controls">
                <div class="user-selector">
                    <span>üë§</span>
                    <select id="userSelect" onchange="changeUser()">
                        <option value="Usuario1">Usuario 1</option>
                        <option value="Usuario2">Usuario 2</option>
                        <option value="Usuario3">Usuario 3</option>
                        <option value="Usuario4">Usuario 4</option>
                    </select>
                </div>
                <div class="theme-toggle" onclick="toggleDarkMode()">
                    <span id="themeIcon">üåô</span>
                    <span id="themeText">Oscuro</span>
                </div>
                <div class="sync-status">
                    <div class="status-dot" id="statusDot"></div>
                    <span id="statusText">Local</span>
                </div>
            </div>
        </header>

        <div class="main-content">
            <div class="section-selector" id="sectionSelector">
                <h2>üìã Mis Categor√≠as</h2>
                
                <div class="search-box">
                    <input type="text" id="categorySearch" placeholder="üîç Buscar categor√≠a..." onkeyup="searchCategories()">
                </div>

                <div class="section-buttons" id="sectionButtons"></div>
                
                <div class="category-manager">
                    <h3>‚ûï Agregar Categor√≠a</h3>
                    <div class="add-category-form">
                        <input type="text" id="newCategoryInput" placeholder="Ej: Ferreter√≠a" maxlength="20">
                        <button class="btn-small" onclick="addCategory()">Agregar</button>
                    </div>
                </div>
            </div>

            <div class="list-container" id="listContainer">
                <div id="offlineWarning" class="offline-mode" style="display:none;">
                    üì¥ Modo local - Datos guardados en este dispositivo
                </div>

                <div class="list-header">
                    <h2 id="listTitle"></h2>
                    <div class="list-actions">
                        <button class="back-btn" onclick="goBack()">‚Üê Volver</button>
                        <button class="export-btn" onclick="showExportOptions()">üì§ Exportar</button>
                        <button class="import-btn" onclick="showImportOptions()">üì• Importar</button>
                        <button class="clear-btn" onclick="clearList()">üóëÔ∏è Limpiar</button>
                    </div>
                </div>

                <div class="search-box">
                    <input type="text" id="itemSearch" placeholder="üîç Buscar art√≠culo..." onkeyup="searchItems()">
                </div>

                <div class="filter-buttons">
                    <button class="active" onclick="filterItems('all')">Todos</button>
                    <button onclick="filterItems('pending')">Pendientes</button>
                    <button onclick="filterItems('completed')">Comprados</button>
                    <button onclick="filterItems('high')">Alta ‚ö†Ô∏è</button>
                    <button onclick="filterItems('medium')">Media ‚ö°</button>
                    <button onclick="filterItems('low')">Baja ‚úì</button>
                </div>

                <div class="sort-controls">
                    <select id="sortSelect" onchange="renderList()">
                        <option value="date">üìÖ M√°s recientes</option>
                        <option value="name">üî§ Nombre A-Z</option>
                        <option value="price-high">üí∞ Precio mayor</option>
                        <option value="price-low">üí∞ Precio menor</option>
                        <option value="priority">‚ö†Ô∏è Prioridad</option>
                    </select>
                </div>

                <div class="chart-container">
                    <div style="font-weight:bold; margin-bottom:8px; font-size:0.9em;">Progreso</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressBar">0%</div>
                    </div>
                </div>

                <div class="stats" id="statsContainer"></div>

                <div class="add-item-section">
                    <h3>‚ûï Agregar Art√≠culo</h3>
                    
                    <div class="quick-add">
                        <button class="quick-add-btn" onclick="quickAdd('Leche')">ü•õ Leche</button>
                        <button class="quick-add-btn" onclick="quickAdd('Pan')">üçû Pan</button>
                        <button class="quick-add-btn" onclick="quickAdd('Huevos')">ü•ö Huevos</button>
                        <button class="quick-add-btn" onclick="quickAdd('Agua')">üíß Agua</button>
                    </div>

                    <div class="form-row">
                        <input type="text" id="itemName" placeholder="Art√≠culo *" class="form-full">
                    </div>
                    <div class="form-row">
                        <input type="number" id="itemQty" placeholder="Cantidad" min="1" value="1">
                        <input type="number" id="itemPrice" placeholder="Precio $" min="0" step="0.01">
                    </div>
                    <div class="form-row">
                        <input type="text" id="itemBrand" placeholder="Marca" class="form-full">
                    </div>
                    <div class="form-row">
                        <input type="text" id="itemStore" placeholder="Tienda/Lugar" class="form-full">
                    </div>
                    <div class="form-row">
                        <textarea id="itemNotes" placeholder="Notas adicionales" class="form-full"></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-full">
                            <div style="margin-bottom:5px; font-size:0.9em; font-weight:600;">Prioridad:</div>
                            <div class="priority-selector">
                                <button class="priority-btn low" onclick="selectPriority('low', this)">‚úì Baja</button>
                                <button class="priority-btn medium active" onclick="selectPriority('medium', this)">‚ö° Media</button>
                                <button class="priority-btn" onclick="selectPriority('high', this)">‚ö†Ô∏è Alta</button>
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <input type="file" id="itemImage" accept="image/*" class="form-full" style="font-size:0.85em;">
                    </div>
                    <button class="add-btn" onclick="addItem()">‚ûï Agregar a la Lista</button>
                </div>

                <ul class="items-list" id="itemsList">
                    <div class="loading">Cargando...</div>
                </ul>
            </div>
        </div>
    </div>

    <div class="modal" id="editModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>‚úèÔ∏è Editar Art√≠culo</h3>
                <button class="close-modal" onclick="closeEditModal()">√ó</button>
            </div>
            <div class="form-row">
                <input type="text" id="editItemName" placeholder="Art√≠culo" class="form-full">
            </div>
            <div class="form-row">
                <input type="number" id="editItemQty" placeholder="Cantidad" min="1">
                <input type="number" id="editItemPrice" placeholder="Precio $" min="0" step="0.01">
            </div>
            <div class="form-row">
                <input type="text" id="editItemBrand" placeholder="Marca" class="form-full">
            </div>
            <div class="form-row">
                <input type="text" id="editItemStore" placeholder="Tienda" class="form-full">
            </div>
            <div class="form-row">
                <textarea id="editItemNotes" placeholder="Notas" class="form-full"></textarea>
            </div>
            <div class="form-row">
                <div class="form-full">
                    <div style="margin-bottom:5px; font-size:0.9em; font-weight:600;">Prioridad:</div>
                    <div class="priority-selector" id="editPrioritySelector">
                        <button class="priority-btn low" onclick="selectEditPriority('low', this)">Baja</button>
                        <button class="priority-btn medium" onclick="selectEditPriority('medium', this)">Media</button>
                        <button class="priority-btn" onclick="selectEditPriority('high', this)">Alta</button>
                    </div>
                </div>
            </div>
            <button class="add-btn" onclick="saveEdit()">üíæ Guardar Cambios</button>
        </div>
    </div>

    <div class="modal" id="imageModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üì∑ Imagen</h3>
                <button class="close-modal" onclick="closeImageModal()">√ó</button>
            </div>
            <img id="modalImage" class="image-preview" src="">
        </div>
    </div>

    <div class="modal" id="exportModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üì§ Exportar Lista</h3>
                <button class="close-modal" onclick="closeExportModal()">√ó</button>
            </div>
            <button class="add-btn" onclick="exportTXT()" style="margin-bottom:10px;">üìÑ Exportar como TXT</button>
            <button class="add-btn" onclick="exportCSV()" style="margin-bottom:10px;">üìä Exportar como CSV</button>
            <button class="add-btn" onclick="exportJSON()">üíæ Exportar como JSON</button>
        </div>
    </div>

    <script>
        let currentSection = null;
        let currentUser = 'Usuario1';
        let currentPriority = 'medium';
        let currentEditPriority = 'medium';
        let currentFilter = 'all';
        let categories = ['supermercado', 'farmacia', 'libreria', 'otros'];
        let lists = {};
        let editingItemId = null;

        categories.forEach(cat => lists[cat] = []);

        function loadFromLocalStorage() {
            try {
                const savedCategories = localStorage.getItem('categories');
                if (savedCategories) categories = JSON.parse(savedCategories);
                
                categories.forEach(cat => {
                    const savedList = localStorage.getItem(`lista_${cat}`);
                    if (savedList) {
                        lists[cat] = JSON.parse(savedList);
                    } else {
                        lists[cat] = [];
                    }
                });
                
                const darkMode = localStorage.getItem('darkMode');
                if (darkMode === 'true') {
                    document.body.classList.add('dark-mode');
                    document.getElementById('themeIcon').textContent = '‚òÄÔ∏è';
                    document.getElementById('themeText').textContent = 'Claro';
                }
            } catch (error) {
                console.error('Error al cargar datos:', error);
            }
        }

        function saveToLocalStorage() {
            try {
                localStorage.setItem('categories', JSON.stringify(categories));
                for (let section in lists) {
                    localStorage.setItem(`lista_${section}`, JSON.stringify(lists[section]));
                }
            } catch (error) {
                console.error('Error al guardar:', error);
            }
        }

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            document.getElementById('themeIcon').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
            document.getElementById('themeText').textContent = isDark ? 'Claro' : 'Oscuro';
            localStorage.setItem('darkMode', isDark);
        }

        function updateStatus(status) {
            const text = document.getElementById('statusText');
            const dot = document.getElementById('statusDot');
            const warning = document.getElementById('offlineWarning');
            
            if (status === 'online') {
                text.textContent = 'En l√≠nea';
                dot.style.background = '#28a745';
                if (warning) warning.style.display = 'none';
            } else {
                text.textContent = 'Local';
                dot.style.background = '#ffc107';
                if (warning) warning.style.display = 'block';
            }
        }

        function renderCategoryButtons() {
            const container = document.getElementById('sectionButtons');
            const icons = {'supermercado':'üõí','farmacia':'üíä','libreria':'üìö','otros':'üì¶'};
            
            container.innerHTML = categories.map(cat => {
                const icon = icons[cat] || 'üìã';
                const name = cat.charAt(0).toUpperCase() + cat.slice(1);
                return `<button class="section-btn" onclick="selectSection('${cat}', event)">${icon} ${name}</button>`;
            }).join('');
        }

        function searchCategories() {
            const search = document.getElementById('categorySearch').value.toLowerCase();
            const buttons = document.querySelectorAll('.section-btn');
            
            buttons.forEach(btn => {
                const text = btn.textContent.toLowerCase();
                btn.style.display = text.includes(search) ? 'block' : 'none';
            });
        }

        function addCategory() {
            const input = document.getElementById('newCategoryInput');
            const name = input.value.trim().toLowerCase();
            
            if (!name) {
                alert('Ingres√° un nombre para la categor√≠a');
                return;
            }
            
            if (categories.includes(name)) {
                alert('Esa categor√≠a ya existe');
                return;
            }
            
            categories.push(name);
            lists[name] = [];
            saveToLocalStorage();
            
            input.value = '';
            renderCategoryButtons();
        }

        function changeUser() {
            currentUser = document.getElementById('userSelect').value;
        }

        function selectPriority(priority, btn) {
            currentPriority = priority;
            document.querySelectorAll('.priority-selector .priority-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }

        function selectEditPriority(priority, btn) {
            currentEditPriority = priority;
            document.querySelectorAll('#editPrioritySelector .priority-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }

        function selectSection(section, event) {
            currentSection = section;
            
            document.querySelectorAll('.section-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');

            const icons = {'supermercado':'üõí','farmacia':'üíä','libreria':'üìö','otros':'üì¶'};
            const icon = icons[section] || 'üìã';
            const name = section.charAt(0).toUpperCase() + section.slice(1);

            document.getElementById('listTitle').textContent = `${icon} ${name}`;
            document.getElementById('listContainer').style.display = 'block';
            document.getElementById('sectionSelector').style.display = 'none';
            clearForm();
            renderList();
        }

        function goBack() {
            currentSection = null;
            document.getElementById('listContainer').style.display = 'none';
            document.getElementById('sectionSelector').style.display = 'block';
            document.querySelectorAll('.section-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('itemSearch').value = '';
            currentFilter = 'all';
            document.querySelectorAll('.filter-buttons button').forEach(b => b.classList.remove('active'));
            document.querySelector('.filter-buttons button').classList.add('active');
        }

        function clearForm() {
            document.getElementById('itemName').value = '';
            document.getElementById('itemQty').value = '1';
            document.getElementById('itemPrice').value = '';
            document.getElementById('itemBrand').value = '';
            document.getElementById('itemStore').value = '';
            document.getElementById('itemNotes').value = '';
            document.getElementById('itemImage').value = '';
            currentPriority = 'medium';
            document.querySelectorAll('.priority-selector .priority-btn').forEach(b => b.classList.remove('active'));
            document.querySelector('.priority-btn.medium').classList.add('active');
        }

        function quickAdd(itemName) {
            document.getElementById('itemName').value = itemName;
            document.getElementById('itemName').focus();
        }

        async function addItem() {
            const name = document.getElementById('itemName').value.trim();
            
            if (!name) {
                alert('Por favor ingres√° el nombre del art√≠culo');
                return;
            }
            
            if (!currentSection) {
                alert('Seleccion√° una categor√≠a primero');
                return;
            }

            let imageData = null;
            const imageFile = document.getElementById('itemImage').files[0];
            if (imageFile) {
                imageData = await fileToBase64(imageFile);
            }

            const newItem = {
                id: Date.now(),
                text: name,
                quantity: parseInt(document.getElementById('itemQty').value) || 1,
                price: parseFloat(document.getElementById('itemPrice').value) || null,
                brand: document.getElementById('itemBrand').value.trim() || null,
                store: document.getElementById('itemStore').value.trim() || null,
                notes: document.getElementById('itemNotes').value.trim() || null,
                priority: currentPriority,
                image: imageData,
                completed: false,
                addedBy: currentUser,
                timestamp: new Date().toISOString()
            };

            lists[currentSection].push(newItem);
            saveToLocalStorage();
            clearForm();
            renderList();
            document.getElementById('itemName').focus();
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        function toggleItem(id) {
            if (!currentSection) return;
            
            const item = lists[currentSection].find(i => i.id === id);
            if (item) {
                item.completed = !item.completed;
                saveToLocalStorage();
                renderList();
            }
        }

        function deleteItem(id) {
            if (!currentSection) return;
            
            if (confirm('¬øEliminar este art√≠culo?')) {
                lists[currentSection] = lists[currentSection].filter(i => i.id !== id);
                saveToLocalStorage();
                renderList();
            }
        }

        function duplicateItem(id) {
            if (!currentSection) return;
            
            const item = lists[currentSection].find(i => i.id === id);
            if (item) {
                const newItem = {...item, id: Date.now(), completed: false};
                lists[currentSection].push(newItem);
                saveToLocalStorage();
                renderList();
            }
        }

        function editItem(id) {
            const item = lists[currentSection].find(i => i.id === id);
            if (!item) return;
            
            editingItemId = id;
            document.getElementById('editItemName').value = item.text;
            document.getElementById('editItemQty').value = item.quantity || 1;
            document.getElementById('editItemPrice').value = item.price || '';
            document.getElementById('editItemBrand').value = item.brand || '';
            document.getElementById('editItemStore').value = item.store || '';
            document.getElementById('editItemNotes').value = item.notes || '';
            
            currentEditPriority = item.priority || 'medium';
            document.querySelectorAll('#editPrioritySelector .priority-btn').forEach(b => {
                b.classList.remove('active');
                if (b.classList.contains(item.priority)) b.classList.add('active');
            });
            
            document.getElementById('editModal').classList.add('active');
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
            editingItemId = null;
        }

        function saveEdit() {
            if (!editingItemId) return;
            
            const name = document.getElementById('editItemName').value.trim();
            if (!name) {
                alert('El nombre del art√≠culo es obligatorio');
                return;
            }
            
            const item = lists[currentSection].find(i => i.id === editingItemId);
            if (item) {
                item.text = name;
                item.quantity = parseInt(document.getElementById('editItemQty').value) || 1;
                item.price = parseFloat(document.getElementById('editItemPrice').value) || null;
                item.brand = document.getElementById('editItemBrand').value.trim() || null;
                item.store = document.getElementById('editItemStore').value.trim() || null;
                item.notes = document.getElementById('editItemNotes').value.trim() || null;
                item.priority = currentEditPriority;
                
                saveToLocalStorage();
                renderList();
                closeEditModal();
            }
        }

        function clearList() {
            if (!currentSection) return;
            
            if (confirm('¬øBORRAR TODOS los art√≠culos de esta lista?')) {
                lists[currentSection] = [];
                saveToLocalStorage();
                renderList();
            }
        }

        function filterItems(filter) {
            currentFilter = filter;
            document.querySelectorAll('.filter-buttons button').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            renderList();
        }

        function searchItems() {
            renderList();
        }

        function showImageModal(imageData) {
            document.getElementById('modalImage').src = imageData;
            document.getElementById('imageModal').classList.add('active');
        }

        function closeImageModal() {
            document.getElementById('imageModal').classList.remove('active');
        }

        function showExportOptions() {
            document.getElementById('exportModal').classList.add('active');
        }

        function closeExportModal() {
            document.getElementById('exportModal').classList.remove('active');
        }

        function showImportOptions() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json,.csv,.txt';
            input.onchange = e => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = event => {
                    try {
                        const data = JSON.parse(event.target.result);
                        if (Array.isArray(data)) {
                            lists[currentSection] = data;
                            saveToLocalStorage();
                            renderList();
                            alert('Lista importada correctamente');
                        }
                    } catch (error) {
                        alert('Error al importar el archivo');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function exportTXT() {
            if (!currentSection) return;
            
            const items = lists[currentSection];
            const name = currentSection.charAt(0).toUpperCase() + currentSection.slice(1);
            
            let text = `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
            text += `   LISTA DE ${name.toUpperCase()}\n`;
            text += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
            text += `Fecha: ${new Date().toLocaleDateString()}\n`;
            text += `Usuario: ${currentUser}\n\n`;
            
            const pending = items.filter(i => !i.completed);
            const completed = items.filter(i => i.completed);
            
            if (pending.length > 0) {
                text += `üìù PENDIENTES (${pending.length}):\n`;
                text += `‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n`;
                pending.forEach((item, idx) => {
                    text += `${idx+1}. ${item.text}`;
                    if (item.quantity > 1) text += ` (x${item.quantity})`;
                    if (item.price) text += ` - ${(item.price * item.quantity).toFixed(2)}`;
                    if (item.priority === 'high') text += ` ‚ö†Ô∏è`;
                    text += `\n`;
                    if (item.brand) text += `   Marca: ${item.brand}\n`;
                    if (item.store) text += `   Tienda: ${item.store}\n`;
                    if (item.notes) text += `   Notas: ${item.notes}\n`;
                    if (item.addedBy) text += `   Por: ${item.addedBy}\n`;
                });
            }
            
            if (completed.length > 0) {
                text += `\n‚úì COMPRADOS (${completed.length}):\n`;
                text += `‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n`;
                completed.forEach((item, idx) => {
                    text += `${idx+1}. ${item.text}`;
                    if (item.quantity > 1) text += ` (x${item.quantity})`;
                    text += `\n`;
                });
            }
            
            let total = 0;
            items.forEach(item => {
                if (item.price) total += item.price * (item.quantity || 1);
            });
            
            if (total > 0) {
                text += `\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
                text += `üí∞ TOTAL: ${total.toFixed(2)}\n`;
                text += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
            }
            
            downloadFile(text, `lista_${currentSection}_${Date.now()}.txt`, 'text/plain');
            closeExportModal();
        }

        function exportCSV() {
            if (!currentSection) return;
            
            const items = lists[currentSection];
            let csv = 'Art√≠culo,Cantidad,Precio,Marca,Tienda,Prioridad,Notas,Completado,Agregado por\n';
            
            items.forEach(item => {
                csv += `"${item.text}",`;
                csv += `${item.quantity || 1},`;
                csv += `${item.price || 0},`;
                csv += `"${item.brand || ''}",`;
                csv += `"${item.store || ''}",`;
                csv += `"${item.priority || 'medium'}",`;
                csv += `"${item.notes || ''}",`;
                csv += `${item.completed ? 'S√≠' : 'No'},`;
                csv += `"${item.addedBy || ''}"\n`;
            });
            
            downloadFile(csv, `lista_${currentSection}_${Date.now()}.csv`, 'text/csv');
            closeExportModal();
        }

        function exportJSON() {
            if (!currentSection) return;
            
            const data = JSON.stringify(lists[currentSection], null, 2);
            downloadFile(data, `lista_${currentSection}_${Date.now()}.json`, 'application/json');
            closeExportModal();
        }

        function downloadFile(content, filename, type) {
            const blob = new Blob([content], { type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        function renderList() {
            if (!currentSection) return;

            const itemsList = document.getElementById('itemsList');
            let items = lists[currentSection];
            
            // Filtrar por b√∫squeda
            const searchTerm = document.getElementById('itemSearch').value.toLowerCase();
            if (searchTerm) {
                items = items.filter(item => 
                    item.text.toLowerCase().includes(searchTerm) ||
                    (item.brand && item.brand.toLowerCase().includes(searchTerm)) ||
                    (item.store && item.store.toLowerCase().includes(searchTerm))
                );
            }
            
            // Filtrar por estado/prioridad
            if (currentFilter !== 'all') {
                if (currentFilter === 'pending') {
                    items = items.filter(i => !i.completed);
                } else if (currentFilter === 'completed') {
                    items = items.filter(i => i.completed);
                } else {
                    items = items.filter(i => i.priority === currentFilter);
                }
            }

            if (items.length === 0) {
                itemsList.innerHTML = '<div class="empty-message">üìù No hay art√≠culos<br><br>¬°Agreg√° el primero!</div>';
                updateStats();
                return;
            }

            // Ordenar
            const sortBy = document.getElementById('sortSelect').value;
            items = [...items].sort((a, b) => {
                if (a.completed !== b.completed) return a.completed ? 1 : -1;
                
                switch(sortBy) {
                    case 'name':
                        return a.text.localeCompare(b.text);
                    case 'price-high':
                        return (b.price || 0) - (a.price || 0);
                    case 'price-low':
                        return (a.price || 0) - (b.price || 0);
                    case 'priority':
                        const priorityOrder = {high: 0, medium: 1, low: 2};
                        return priorityOrder[a.priority || 'medium'] - priorityOrder[b.priority || 'medium'];
                    default:
                        return b.id - a.id;
                }
            });

            itemsList.innerHTML = items.map(item => {
                let details = '';
                if (item.quantity > 1) details += `<div class="item-detail-row"><span class="item-detail-label">Cantidad:</span> ${item.quantity}</div>`;
                if (item.price) {
                    const total = item.price * (item.quantity || 1);
                    details += `<div class="item-detail-row"><span class="item-detail-label">Precio:</span> ${item.price.toFixed(2)}${item.quantity > 1 ? ` (Total: ${total.toFixed(2)})` : ''}</div>`;
                }
                if (item.brand) details += `<div class="item-detail-row"><span class="item-detail-label">Marca:</span> ${item.brand}</div>`;
                if (item.store) details += `<div class="item-detail-row"><span class="item-detail-label">Tienda:</span> ${item.store}</div>`;
                if (item.notes) details += `<div class="item-detail-row"><span class="item-detail-label">Notas:</span> ${item.notes}</div>`;
                if (item.addedBy) details += `<div class="item-detail-row"><span class="item-detail-label">Por:</span> ${item.addedBy}</div>`;
                
                let priceDisplay = '';
                if (item.price) {
                    const total = item.price * (item.quantity || 1);
                    priceDisplay = `<span class="item-price">${total.toFixed(2)}</span>`;
                }
                
                let priorityBadge = '';
                if (item.priority === 'high') priorityBadge = '<span class="priority-badge priority-high-badge">‚ö†Ô∏è Alta</span>';
                else if (item.priority === 'low') priorityBadge = '<span class="priority-badge priority-low-badge">‚úì Baja</span>';
                else priorityBadge = '<span class="priority-badge priority-medium-badge">‚ö° Media</span>';
                
                let imageHTML = '';
                if (item.image) {
                    imageHTML = `<img src="${item.image}" class="item-image" onclick="showImageModal('${item.image}')" alt="Imagen del producto">`;
                }
                
                return `
                    <li class="item ${item.completed ? 'completed' : ''} priority-${item.priority || 'medium'}">
                        <div class="item-header">
                            <input type="checkbox" 
                                   ${item.completed ? 'checked' : ''} 
                                   onchange="toggleItem(${item.id})"
                                   aria-label="Marcar">
                            <span class="item-text">${escapeHtml(item.text)}</span>
                            ${priorityBadge}
                            ${priceDisplay}
                        </div>
                        ${details ? `<div class="item-details">${details}</div>` : ''}
                        ${imageHTML}
                        <div class="item-actions">
                            <button class="edit-btn" onclick="editItem(${item.id})">‚úèÔ∏è</button>
                            <button class="duplicate-btn" onclick="duplicateItem(${item.id})">üìã</button>
                            <button class="delete-btn" onclick="deleteItem(${item.id})">üóëÔ∏è</button>
                        </div>
                    </li>
                `;
            }).join('');

            updateStats();
        }

        function updateStats() {
            if (!currentSection) return;

            const items = lists[currentSection];
            const total = items.length;
            const completed = items.filter(i => i.completed).length;
            const pending = total - completed;
            const highPriority = items.filter(i => i.priority === 'high' && !i.completed).length;
            
            let totalPrice = 0;
            let pendingPrice = 0;
            
            items.forEach(item => {
                if (item.price) {
                    const itemTotal = item.price * (item.quantity || 1);
                    totalPrice += itemTotal;
                    if (!item.completed) pendingPrice += itemTotal;
                }
            });

            const percentage = total > 0 ? Math.round((completed/total)*100) : 0;
            document.getElementById('progressBar').style.width = percentage + '%';
            document.getElementById('progressBar').textContent = percentage + '%';

            let statsHTML = `
                <div class="stat">
                    <div class="stat-number">${total}</div>
                    <div class="stat-label">Total</div>
                </div>
                <div class="stat">
                    <div class="stat-number">${pending}</div>
                    <div class="stat-label">Pendientes</div>
                </div>
                <div class="stat">
                    <div class="stat-number">${completed}</div>
                    <div class="stat-label">Comprados</div>
                </div>
                <div class="stat">
                    <div class="stat-number">${highPriority}</div>
                    <div class="stat-label">Alta ‚ö†Ô∏è</div>
                </div>
                <div class="stat">
                    <div class="stat-number">${percentage}%</div>
                    <div class="stat-label">Progreso</div>
                </div>
            `;
            
            if (totalPrice > 0) {
                statsHTML += `
                <div class="stat">
                    <div class="stat-number">${totalPrice.toFixed(2)}</div>
                    <div class="stat-label">Total $</div>
                </div>
                <div class="stat">
                    <div class="stat-number">${pendingPrice.toFixed(2)}</div>
                    <div class="stat-label">Falta $</div>
                </div>
                <div class="stat">
                    <div class="stat-number">${(totalPrice - pendingPrice).toFixed(2)}</div>
                    <div class="stat-label">Gastado</div>
                </div>
                `;
            }

            document.getElementById('statsContainer').innerHTML = statsHTML;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function init() {
            loadFromLocalStorage();
            renderCategoryButtons();
            updateStatus('local');
            
            document.getElementById('itemName').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    addItem();
                }
            });
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>
